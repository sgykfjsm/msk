# internal/project

This package encapsulates logic related to managing TiDB Cloud "projects".

It is responsible for:
- Fetching project list via the [TiDB Cloud API](https://docs.pingcap.com/tidbcloud/api/v1beta/#tag/Project/operation/ListProjects)
- Coordinating retrieval, transformation, and persistence of project data
- Persisting the project list into a TiDB-compatible database using upsert strategy

## Structure

- `fetcher.go`: Defines `ProjectFetcher` interface for its API-based implementation, and `ProjectStore` interface for DB operations.
- `service.go`: Implements `ProjectService` to orchestrate fetch and store logic
- `mocks_test.go`: Auto-generated mock interfaces using [mockery](https://github.com/vektra/mockery)
- `service_test.go`: Unit tests for `ProjectService` using mocks
- `fetcher_test.go`: Unit tests for `ProjectFetcher`, which are mainly testing API-based implementations.

## Design Notes

- Project and organization IDs (`id`, `org_id`) are stored as `VARCHAR` to match TiDB Cloud API types (`string<uint64>`).
- Data is not historical; each fetch replaces the entire set of projects with the latest state.
- Upsert (`INSERT ... ON DUPLICATE KEY UPDATE`) is used to maintain a single row per project.

## Related CLI Command

- `fetch-projects` (defined in `cmd/projects.go`)

## Error Handling

- API and DB errors are propagated from the core logic; no logging is done at this layer.
- Logging is expected to be handled by the CLI (caller) layer.
- Fatal errors (e.g. DB transaction failure) are returned to the caller for appropriate handling.

## Testing Policy

- Unit tests cover normal and failure flows in service and fetcher layers.
- Interfaces are mocked using `mockery` to isolate API and DB dependencies.
- DB-level tests are deferred to end-to-end (E2E) testing.
