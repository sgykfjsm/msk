# cmd/fetch-clusters

This subcommand is responsible for retrieving the list of clusters for one or more projects
via the [TiDB Cloud API](https://docs.pingcap.com/tidbcloud/api/v1beta/#tag/Cluster/operation/ListClusters)
and storing them into the local database.

## Purpose

Provide a standalone, testable CLI entry point for fetching and persisting cluster metadata
associated with TiDB Cloud projects.

## Behavior

* Receives arguments and flags from the command line
* Loads sensitive configurations such as API credentials and database password from environment variables
* Determines the set of target projects:
  - If `--project-id` is given, fetches clusters for that project only
  - If `--all` is specified, fetches project list from the database and processes each one
* Calls the service layer (`ClusterService`) to perform the fetch-and-store logic
* Delegates execution to `runFetchAndStoreClustersService`, which coordinates the operation
* Logs errors and results in a human-friendly manner
* Returns non-zero exit code on failure

## Structure

`fetch_clusters.go`: CLI command entry point. It:
- Parses CLI arguments via `parseFetchClusterArgs`
- Validates inputs via `validateFetchClusterArgs`
- Initializes the API fetcher and DB store
- Loads project IDs to be processed (via CLI flag or DB)
- Delegates the fetch/store operation to `ClusterService`

## Internals

* The command collects CLI flags into a `fetchClusterArgs` struct for clarity and testability
* Core logic is fully delegated to `internal/cluster` — the command file only orchestrates

## Environment Variables

This command supports the following environment variables for sensitive data:

- `MSK_API_KEY`: TiDB Cloud API public key
- `MSK_API_SECRET`: TiDB Cloud API private key
- `MSK_DB_PASSWORD`: Database password

## Flags

- `--project-id`: Target project ID to fetch clusters from (optional if `--all` is set)
- `--all`: If set, fetch clusters from all projects stored in the database

## Ownership

* This subcommand is owned by the `internal/cluster` module
* This command **must not** directly access APIs or the database — it must delegate

## Future Extensions

* Add `--update-projects` flag to run `fetch-projects` before cluster retrieval
  (e.g., `fetch-projects && fetch-clusters` in one step)
* Option to filter by cluster name or status
* Option to export results in JSON format for integration
